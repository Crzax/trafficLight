C51 COMPILER V9.60.7.0   MAIN                                                              11/01/2024 02:41:28 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Developer\Keil_5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /**************************************************
   2           * Author:       陈震雄
   3           * Date:         2024-10-29
   4           * Description:  交通灯实现文件
   5           **************************************************/
   6          #include "TrafficLight.h"
   7          #include <REGX52.H>
   8          #include "Timer.h"
   9          #include "LED.h"
  10          #include "Buzzer.h"
  11          #include "Key.h"
  12          #include "MatrixKey.h"
  13          #include "IR.h"
  14          
  15          /**************************交通灯************************************/
  16          // 交通灯结构体
  17          typedef struct {
  18              unsigned char greenLightPin;        // 绿灯对应的P2位寄存器
  19              unsigned char redLightPin;          // 红灯对应的P2位寄存器
  20              unsigned int time;                          // 所剩时间
  21              unsigned char flag;                         // 标识红/绿/黄灯
  22                  unsigned char isBlink;                  // 是否闪烁
  23          } TrafficLight;
  24          
  25          unsigned char isSet = 0;                // 是否进入设置倒计时模式
  26          extern unsigned char buzzerFlag;        // 是否开始叫的一个判断依据
  27          // 置黄灯
  28          void setYellow(TrafficLight* self) {
  29   1          P2 &= ~(1 << self->greenLightPin);  // 打开绿灯
  30   1          P2 &= ~(1 << self->redLightPin);    // 打开红灯
  31   1          self->flag = YELLOW;
  32   1          self->time = YELLOWTIME;
  33   1      }
  34          
  35          // 置绿灯
  36          void setGreen(TrafficLight* self) {
  37   1          P2 &= ~(1 << self->greenLightPin);   // 打开绿灯
  38   1          P2 |= 1 << self->redLightPin;    // 关闭红灯
  39   1          self->flag = GREEN;
  40   1          self->time = GREENTIME;
  41   1      }
  42          
  43          // 置红灯
  44          void setRed(TrafficLight* self) {
  45   1          P2 |= 1 << self->greenLightPin;  // 关闭绿灯
  46   1          P2 &= ~(1 << self->redLightPin);     // 打开红灯
  47   1          self->flag = RED;
  48   1          self->time = REDTIME;
  49   1      }
  50          
  51          // 闪烁
  52          void blink(TrafficLight* self) {
  53   1              if (self->flag==RED) {
  54   2                      P2 ^= 1 << self->redLightPin;
C51 COMPILER V9.60.7.0   MAIN                                                              11/01/2024 02:41:28 PAGE 2   

  55   2              } else {
  56   2                      P2 ^= 1 << self->greenLightPin;
  57   2              }
  58   1      }
  59          
  60          // 南北向交通灯
  61          TrafficLight SN = {0, 1, GREENTIME, GREEN,0};
  62          
  63          // 东西向交通灯
  64          TrafficLight EW = {6, 7, REDTIME, RED,0};
  65          
  66          /**************************初始化函数************************************/
  67          void init() {
  68   1          setGreen(&SN);
  69   1          setRed(&EW);
  70   1      }
  71          
  72          /**************************主函数************************************/
  73          void main() {
  74   1              unsigned char keyNum = 0;
  75   1              unsigned char matrixKeyNum = INVALID;   
  76   1              unsigned char IRNum = INVALID;
  77   1              unsigned char i = 0;
  78   1              
  79   1          Timer0Init();
  80   1      //      Timer1Init();
  81   1              IR_Init();
  82   1          init();
  83   1          while(1) {
  84   2                      /**************************低于3s闪烁，否则正常(黄灯除外)**************************/
  85   2                      if (SN.isBlink) {       
  86   3                              showNum(1,666);
  87   3                      } else {
  88   3                              showNum(1, SN.time);
  89   3                      }
  90   2                      if (EW.isBlink) {       
  91   3                              showNum(2,666);
  92   3                      } else {
  93   3                              showNum(2, EW.time);
  94   3                      }
  95   2                      
  96   2                      /**************************绿灯&&低于3s开始鸣叫**************************/
  97   2                      if (SN.flag==GREEN&&SN.time<=BUZZERTIME) {
  98   3                              setBuzzer();
  99   3                      }
 100   2                      
 101   2                      if (EW.flag==GREEN&&EW.time<=BUZZERTIME) {
 102   3                              setBuzzer();
 103   3                      }
 104   2      
 105   2                      /*************紧急情况，延长红灯时间3秒(对应另一个路口它的状态也延长三秒)***
             -*************/
 106   2                      keyNum = Key();
 107   2                      if (keyNum==1) {
 108   3                              SN.time += 3;
 109   3                              EW.time += 3;
 110   3                      }
 111   2                      
 112   2                      /**************************设置倒计时模式(矩阵键盘)**************************/
 113   2                      if (keyNum == 2 && SN.flag!=YELLOW) {
 114   3                              isSet = 1;
 115   3                              SN.time = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              11/01/2024 02:41:28 PAGE 3   

 116   3                              // 第二个数码管不显示
 117   3                              showNum(2,666);
 118   3      
 119   3                              // 获取两个输入
 120   3                              for(i=0;i<3;) {
 121   4                                      while(1) {
 122   5                                              showNum(1, SN.time);
 123   5                                              matrixKeyNum =  matrixKey();
 124   5                                              if (matrixKeyNum<INVALID) break; 
 125   5                                      }
 126   4                                      if (i<2&&matrixKeyNum<=10) {
 127   5                                              SN.time *= 10;
 128   5                                              SN.time += matrixKeyNum % 10;
 129   5                                              SN.time %= 100;
 130   5                                              ++i;
 131   5                                      }
 132   4                                      if (matrixKeyNum==ADDONE) {SN.time++; SN.time %= 100;}
 133   4                                      if (matrixKeyNum==SUBONE) {SN.time--; SN.time %= 100;}
 134   4                                      if (matrixKeyNum==OK) break;
 135   4                                      if (matrixKeyNum==CLEAR) {
 136   5                                              SN.time = 0;
 137   5                                              i=0;
 138   5                                      }
 139   4                                      matrixKeyNum = INVALID;
 140   4                              }
 141   3                              
 142   3                              if (SN.flag==GREEN) {
 143   4                                      // 南北绿灯，则东西只能红灯
 144   4                                      EW.flag=RED;
 145   4                                      EW.time = SN.time + YELLOWTIME;
 146   4                              } else {
 147   4                                      // 南北红灯，东西黄灯
 148   4                                      if (SN.time <= YELLOWTIME) {
 149   5                                              EW.flag = YELLOW;
 150   5                                              EW.time = SN.time;
 151   5                                      } else {
 152   5                                              // 南北红灯，东西绿灯
 153   5                                              EW.flag = GREEN;
 154   5                                              EW.time = SN.time - YELLOWTIME;
 155   5                                      }
 156   4                              }
 157   3                              isSet = 0;
 158   3                      }
 159   2                      /**************************设置倒计时模式(红外线遥控器)**************************/
 160   2                      if (IR_GetDataFlag() && IR_GetCommand() == IR_MODE) {
 161   3                              isSet = 1;
 162   3                              SN.time = 0;
 163   3                              
 164   3                              // 第二个数码管不显示
 165   3                              showNum(2,666);
 166   3                              // 获取两个输入
 167   3                              for(i=0;i<3;) {
 168   4                                      while(1) {
 169   5                                              showNum(1, SN.time);
 170   5                                              IRNum =  IR_GetNumber();
 171   5                                              if (IRNum<INVALID) break; 
 172   5                                      }
 173   4                                      if (i<2 && IRNum<10) {
 174   5                                              SN.time *= 10;
 175   5                                              SN.time += IRNum;
 176   5                                              SN.time %= 100;
 177   5                                              ++i;
C51 COMPILER V9.60.7.0   MAIN                                                              11/01/2024 02:41:28 PAGE 4   

 178   5                                      }
 179   4                                      if (IRNum==ADDONE) {SN.time++; SN.time %= 100;}
 180   4                                      if (IRNum==SUBONE) {SN.time--; SN.time %= 100;}
 181   4                                      if (IRNum==OK) {SN.time %= 100; break;}
 182   4                                      if (IRNum==CLEAR) {
 183   5                                              SN.time = 0;
 184   5                                              i=0;
 185   5                                      }
 186   4                                      IRNum = INVALID;
 187   4                              }
 188   3                              
 189   3                              if (SN.flag==GREEN) {
 190   4                                      // 南北绿灯，则东西只能红灯
 191   4                                      EW.flag=RED;
 192   4                                      EW.time = SN.time + YELLOWTIME;
 193   4                              } else {
 194   4                                      // 南北红灯，东西黄灯
 195   4                                      if (SN.time <= YELLOWTIME) {
 196   5                                              EW.flag = YELLOW;
 197   5                                              EW.time = SN.time;
 198   5                                      } else {
 199   5                                              // 南北红灯，东西绿灯
 200   5                                              EW.flag = GREEN;
 201   5                                              EW.time = SN.time - YELLOWTIME;
 202   5                                      }
 203   4                              }
 204   3                              isSet = 0;
 205   3                      }
 206   2          }
 207   1      }
 208          
 209          /********************T0计时器中断处理-交通灯LED/数码管*************************/
 210          void Timer0_Routine() interrupt 1 {     // 500us一次中断
 211   1          static unsigned int T0Count;
 212   1          
 213   1              TL0 = 0x33;        // 设置定时初值
 214   1          TH0 = 0xFE;        // 设置定时初值
 215   1              buzzerFlag = 1;    // 500微秒置1，即1kHZ振动蜂鸣器
 216   1              if (isSet) {T0Count = 0; return;}       // 进入设置模式，则计数器回到初始状态
 217   1          T0Count++;
 218   1              
 219   1              // 最后3s每1s闪一次(一次暗亮)，黄灯除外
 220   1          if (T0Count == 10*100 || T0Count == 20*100) {
 221   2              // 南北方向闪烁处理
 222   2              if (SN.time <= BLINKTIME && SN.flag != YELLOW) {   
 223   3                              SN.isBlink = !SN.isBlink;
 224   3                              if (SN.time == 0) SN.isBlink = 0;       // 0s应该让Blink=0，防止后面不显示
 225   3                              blink(&SN);
 226   3              }       
 227   2              // 东西方向闪烁处理
 228   2              if (EW.time <= BLINKTIME && EW.flag != YELLOW) {
 229   3                              EW.isBlink = !EW.isBlink;
 230   3                              if (EW.time == 0)       EW.isBlink = 0; // 0s应该让Blink=0，防止后面不显示
 231   3                              blink(&EW);
 232   3              }
 233   2          }
 234   1              
 235   1              // 每一秒
 236   1              if (T0Count == 20*100) {
 237   2                      T0Count = 0;
 238   2                      SN.time--;
 239   2                      EW.time--;
C51 COMPILER V9.60.7.0   MAIN                                                              11/01/2024 02:41:28 PAGE 5   

 240   2              
 241   2                      // 时间到了，南北换灯
 242   2              if (SN.time == 0) {
 243   3                  if (SN.flag == GREEN) {
 244   4                      setYellow(&SN);
 245   4                  } else if (SN.flag == YELLOW) {
 246   4                      setRed(&SN);
 247   4                  } else if (SN.flag == RED) {
 248   4                      setGreen(&SN);
 249   4                  }
 250   3              }
 251   2                      // 时间到了，东西换灯
 252   2              if (EW.time == 0) {
 253   3                  if (EW.flag == GREEN) {
 254   4                      setYellow(&EW);
 255   4                  } else if (EW.flag == YELLOW) {
 256   4                      setRed(&EW);
 257   4                  } else if (EW.flag == RED) {
 258   4                      setGreen(&EW);
 259   4                  }
 260   3              }
 261   2              }
 262   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1222    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     15       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
